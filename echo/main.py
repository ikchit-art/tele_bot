import datetime
from logging import getLogger
from subprocess import Popen
from subprocess import PIPE
from uuid import uuid4

from telegram import Bot
from telegram import Update
from telegram import ParseMode
from telegram import InlineKeyboardButton
from telegram import InlineKeyboardMarkup
from telegram import InlineQueryResultArticle
from telegram import InputTextMessageContent
from telegram import ReplyKeyboardRemove
from telegram.ext import Updater
from telegram.ext import CommandHandler
from telegram.ext import MessageHandler
from telegram.ext import Filters
from telegram.ext import CallbackQueryHandler
from telegram.ext import InlineQueryHandler
from telegram.utils.helpers import escape_markdown

from apis.bittrex import BittrexClient
from apis.bittrex import BittrexError
from echo.config import load_config
from echo.buttons import BUTTON1_HELP
from echo.buttons import BUTTON2_TIME
from echo.buttons import get_base_reply_keyboard


config = load_config()

logger = getLogger(__name__)


def debug_requests(f):
    """ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º–∞
    """
    def inner(*args, **kwargs):
        try:
            logger.info("–û–±—Ä–∞—â–µ–Ω–∏–µ –≤ —Ñ—É–Ω–∫—Ü–∏—é {}".format(f.__name__))
            return f(*args, **kwargs)
        except Exception:
            logger.exception("–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ {}".format(f.__name__))
            if len(args) == 2:
                update = args[1]
                logger.error("–°–æ–æ–±—â–µ–Ω–∏–µ: %s", update.effective_message)
            raise

    return inner


# `callback_data` -- —ç—Ç–æ —Ç–æ, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å TG –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–∞–∂–¥—É—é –∫–Ω–æ–ø–∫—É.
# –ü–æ—ç—Ç–æ–º—É –∫–∞–∂–¥—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º
CALLBACK_BUTTON1_LEFT = "callback_button1_left"
CALLBACK_BUTTON2_RIGHT = "callback_button2_right"
CALLBACK_BUTTON3_MORE = "callback_button3_more"
CALLBACK_BUTTON4_BACK = "callback_button4_back"
CALLBACK_BUTTON5_TIME = "callback_button5_time"
CALLBACK_BUTTON6_PRICE = "callback_button6_price"
CALLBACK_BUTTON7_PRICE = "callback_button7_price"
CALLBACK_BUTTON8_PRICE = "callback_button8_price"
CALLBACK_BUTTON_HIDE_KEYBOARD = "callback_button9_hide"


TITLES = {
    CALLBACK_BUTTON1_LEFT: "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚ö°Ô∏è",
    CALLBACK_BUTTON2_RIGHT: "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚úèÔ∏è",
    CALLBACK_BUTTON3_MORE: "–ï—â—ë ‚û°Ô∏è",
    CALLBACK_BUTTON4_BACK: "–ù–∞–∑–∞–¥ ‚¨ÖÔ∏è",
    CALLBACK_BUTTON5_TIME: "–í—Ä–µ–º—è ‚è∞",
    CALLBACK_BUTTON6_PRICE: "BTC üí∞",
    CALLBACK_BUTTON7_PRICE: "LTC üí∞",
    CALLBACK_BUTTON8_PRICE: "ETH üí∞",
    CALLBACK_BUTTON_HIDE_KEYBOARD: "–°–ø—Ä—è—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É",
}

# –ì–ª–æ–±–∞–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç API Bittrex
client = BittrexClient()


def get_base_inline_keyboard():
    """ –ü–æ–ª—É—á–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
        –≠—Ç–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –±—É–¥–µ—Ç –≤–∏–¥–Ω–∞ –ø–æ–¥ –∫–∞–∂–¥—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, –≥–¥–µ –µ—ë –ø—Ä–∏–∫—Ä–µ–ø–∏–ª–∏
    """
    # –ö–∞–∂–¥—ã–π —Å–ø–∏—Å–æ–∫ –≤–Ω—É—Ç—Ä–∏ `keyboard` -- —ç—Ç–æ –æ–¥–∏–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä—è–¥ –∫–Ω–æ–ø–æ–∫
    keyboard = [
        # –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞ -- —ç—Ç–æ –æ–¥–∏–Ω –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü.
        # –°–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫ -- —Å—Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª–±—Ü–æ–≤
        [
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON1_LEFT], callback_data=CALLBACK_BUTTON1_LEFT),
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON2_RIGHT], callback_data=CALLBACK_BUTTON2_RIGHT),
        ],
        [
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON_HIDE_KEYBOARD], callback_data=CALLBACK_BUTTON_HIDE_KEYBOARD),
        ],
        [
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON3_MORE], callback_data=CALLBACK_BUTTON3_MORE),
        ],
    ]
    return InlineKeyboardMarkup(keyboard)


def get_keyboard2():
    """ –ü–æ–ª—É—á–∏—Ç—å –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
        –í–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –ø–µ—Ä–≤–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
    """
    keyboard = [
        [
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON5_TIME], callback_data=CALLBACK_BUTTON5_TIME),
        ],
        [
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON6_PRICE], callback_data=CALLBACK_BUTTON6_PRICE),
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON7_PRICE], callback_data=CALLBACK_BUTTON7_PRICE),
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON8_PRICE], callback_data=CALLBACK_BUTTON8_PRICE),
        ],
        [
            InlineKeyboardButton(TITLES[CALLBACK_BUTTON4_BACK], callback_data=CALLBACK_BUTTON4_BACK),
        ],
    ]
    return InlineKeyboardMarkup(keyboard)


@debug_requests
def keyboard_callback_handler(bot: Bot, update: Update, **kwargs):
    """ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –í–°–ï–• –∫–Ω–æ–ø–æ–∫ —Å–æ –í–°–ï–• –∫–ª–∞–≤–∏–∞—Ç—É—Ä
    """
    query = update.callback_query
    data = query.data
    now = datetime.datetime.now()

    # –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `effective_message`
    chat_id = update.effective_message.chat_id
    current_text = update.effective_message.text

    if data == CALLBACK_BUTTON1_LEFT:
        # "–£–¥–∞–ª–∏–º" –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —É –ø—Ä–æ—à–ª–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        # (–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –µ–≥–æ —Ç–∞–∫, —á—Ç–æ —Ç–µ–∫—Å—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ç–æ—Ç –∂–µ, –∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø—Ä–æ–ø–∞–¥—ë—Ç)
        query.edit_message_text(
            text=current_text,
            parse_mode=ParseMode.MARKDOWN,
        )
        # –û—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
        bot.send_message(
            chat_id=chat_id,
            text="–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n\ncallback_query.data={}".format(data),
            reply_markup=get_base_inline_keyboard(),
        )
    elif data == CALLBACK_BUTTON2_RIGHT:
        # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        query.edit_message_text(
            text="–£—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ {}".format(now),
            reply_markup=get_base_inline_keyboard(),
        )
    elif data == CALLBACK_BUTTON3_MORE:
        # –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —ç–∫—Ä–∞–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        # (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç, –Ω–æ —É–∫–∞–∑–∞—Ç—å –¥—Ä—É–≥–æ–π –º–∞—Å—Å–∏–≤ –∫–Ω–æ–ø–æ–∫)
        query.edit_message_text(
            text=current_text,
            reply_markup=get_keyboard2(),
        )
    elif data == CALLBACK_BUTTON4_BACK:
        # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        # (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç, –Ω–æ —É–∫–∞–∑–∞—Ç—å –¥—Ä—É–≥–æ–π –º–∞—Å—Å–∏–≤ –∫–Ω–æ–ø–æ–∫)
        query.edit_message_text(
            text=current_text,
            reply_markup=get_base_inline_keyboard(),
        )
    elif data == CALLBACK_BUTTON5_TIME:
        # –ü–æ–∫–∞–∂–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏ –æ—Å—Ç–∞–≤–∏–º —Ç—É –∂–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        text = "*–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è*\n\n{}".format(now)
        query.edit_message_text(
            text=text,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=get_keyboard2(),
        )
    elif data in (CALLBACK_BUTTON6_PRICE, CALLBACK_BUTTON7_PRICE, CALLBACK_BUTTON8_PRICE):
        pair = {
            CALLBACK_BUTTON6_PRICE: "USD-BTC",
            CALLBACK_BUTTON7_PRICE: "USD-LTC",
            CALLBACK_BUTTON8_PRICE: "USD-ETH",
        }[data]

        try:
            current_price = client.get_last_price(pair=pair)
            text = "*–ö—É—Ä—Å –≤–∞–ª—é—Ç—ã:*\n\n*{}* = {}$".format(pair, current_price)
        except BittrexError:
            text = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ :(\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑"
        query.edit_message_text(
            text=text,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=get_keyboard2(),
        )
    elif data == CALLBACK_BUTTON_HIDE_KEYBOARD:
        # –°–ø—Ä—è—Ç–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        # –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        # –ú–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ —Ç–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —Ç–æ—á–Ω–æ –∑–Ω–∞—Ç—å —á—Ç–æ —É —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –±—ã–ª–æ –∫–Ω–æ–ø–æ–∫
        bot.send_message(
            chat_id=chat_id,
            text="–°–ø—Ä—è—Ç–∞–ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É\n\n–ù–∞–∂–º–∏—Ç–µ /start —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –µ—ë –æ–±—Ä–∞—Ç–Ω–æ",
            reply_markup=ReplyKeyboardRemove(),
        )


@debug_requests
def do_start(bot: Bot, update: Update):
    bot.send_message(
        chat_id=update.message.chat_id,
        text="–ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å",
        reply_markup=get_base_reply_keyboard(),
    )


@debug_requests
def do_help(bot: Bot, update: Update):
    bot.send_message(
        chat_id=update.message.chat_id,
        text="–≠—Ç–æ —É—á–µ–±–Ω—ã–π –±–æ—Ç\n\n"
             "–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –µ—Å—Ç—å –≤ –º–µ–Ω—é\n\n"
             "–¢–∞–∫ –∂–µ —è –æ—Ç–≤–µ—á—É—é –Ω–∞ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
        reply_markup=get_base_inline_keyboard(),
    )


@debug_requests
def do_time(bot: Bot, update: Update):
    """ –£–∑–Ω–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è
    """
    process = Popen(["date"], stdout=PIPE)
    text, error = process.communicate()
    # –ú–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –æ—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–µ 0)
    if error:
        text = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –≤—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    else:
        # –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞
        text = text.decode("utf-8")
    bot.send_message(
        chat_id=update.message.chat_id,
        text=text,
        reply_markup=get_base_inline_keyboard(),
    )


@debug_requests
def do_echo(bot: Bot, update: Update):
    chat_id = update.message.chat_id
    text = update.message.text
    if text == BUTTON1_HELP:
        return do_help(bot=bot, update=update)
    elif text == BUTTON2_TIME:
        return do_time(bot=bot, update=update)
    else:
        reply_text = "–í–∞—à ID = {}\n\n{}".format(chat_id, text)
        bot.send_message(
            chat_id=chat_id,
            text=reply_text,
            reply_markup=get_base_inline_keyboard(),
        )


@debug_requests
def inline_query_handler(bot: Bot, update: Update):
    query = update.inline_query.query
    results = [
        InlineQueryResultArticle(
            id=uuid4(),
            title="Caps",
            input_message_content=InputTextMessageContent(query.upper()),
        ),
        InlineQueryResultArticle(
            id=uuid4(),
            title="Bold",
            input_message_content=InputTextMessageContent(
                "*{}*".format(escape_markdown(query)),
                parse_mode=ParseMode.MARKDOWN,
            ),
        ),
        InlineQueryResultArticle(
            id=uuid4(),
            title="Italic",
            input_message_content=InputTextMessageContent(
                "_{}_".format(escape_markdown(query)),
                parse_mode=ParseMode.MARKDOWN,
            ),
        ),
    ]
    update.inline_query.answer(results)


def main():
    bot = Bot(
        token=config.TG_TOKEN,
        base_url=config.TG_API_URL,
    )
    updater = Updater(
        bot=bot,
    )
    logger.info("–ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ %s", updater.bot.username)

    start_handler = CommandHandler("start", do_start)
    help_handler = CommandHandler("help", do_help)
    time_handler = CommandHandler("time", do_time)
    message_handler = MessageHandler(Filters.text, do_echo)
    buttons_handler = CallbackQueryHandler(callback=keyboard_callback_handler)
    inline_handler = InlineQueryHandler(callback=inline_query_handler)

    updater.dispatcher.add_handler(start_handler)
    updater.dispatcher.add_handler(help_handler)
    updater.dispatcher.add_handler(time_handler)
    updater.dispatcher.add_handler(message_handler)
    updater.dispatcher.add_handler(buttons_handler)
    # updater.dispatcher.add_handler(inline_handler)

    # –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    updater.start_polling()
    # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    updater.idle()

    logger.info("–ó–∞–∫–æ–Ω—á–∏–ª–∏...")


if __name__ == '__main__':
    main()
